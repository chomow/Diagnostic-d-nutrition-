import React, { useState } from 'react';
import { AlertCircle, CheckCircle, Info, FileText, Mail } from 'lucide-react';

export default function DenutritionEvaluation() {
  const [step, setStep] = useState(0);
  const [answers, setAnswers] = useState({});
  const [result, setResult] = useState(null);

  const questions = [
    {
      id: 'age',
      question: "Âge du patient (en années)",
      type: 'number',
      placeholder: 'Ex: 65'
    },
    {
      id: 'height',
      question: "Taille du patient (en cm)",
      type: 'number',
      placeholder: 'Ex: 170'
    },
    {
      id: 'current_weight',
      question: "Poids actuel (en kg)",
      type: 'number',
      placeholder: 'Ex: 65.5'
    },
    {
      id: 'weight_1month',
      question: "Poids il y a 1 mois (en kg)",
      type: 'number',
      placeholder: 'Laisser vide si inconnu',
      optional: true
    },
    {
      id: 'weight_6months',
      question: "Poids il y a 6 mois (en kg)",
      type: 'number',
      placeholder: 'Laisser vide si inconnu',
      optional: true
    },
    {
      id: 'weight_before_illness',
      question: "Poids habituel avant la maladie (en kg)",
      type: 'number',
      placeholder: 'Laisser vide si inconnu',
      optional: true
    },
    {
      id: 'food_intake',
      question: "Réduction de la prise alimentaire",
      type: 'select',
      options: [
        'Pas de réduction',
        'Réduction ≥ 50% pendant > 1 semaine',
        'Réduction pendant > 2 semaines (quelle que soit l\'intensité)'
      ]
    },
    {
      id: 'malabsorption',
      question: "Malabsorption ou maldigestion digestive",
      type: 'select',
      options: ['Non', 'Oui']
    },
    {
      id: 'pathology',
      question: "Situation d'agression",
      type: 'select',
      options: [
        'Aucune',
        'Pathologie aiguë',
        'Pathologie chronique évolutive',
        'Pathologie maligne évolutive'
      ]
    },
    {
      id: 'sarcopenia',
      question: "Sarcopénie confirmée (réduction de la force ET de la masse musculaire)",
      type: 'select',
      options: ['Non', 'Oui', 'Non évaluée']
    },
    {
      id: 'albumin',
      question: "Albuminémie (si disponible)",
      type: 'select',
      options: ['≥ 35 g/L', '30-35 g/L', '< 30 g/L', 'Non disponible']
    }
  ];

  const evaluateDenutrition = () => {
    const age = parseInt(answers.age);

    const height = parseFloat(answers.height) / 100;
    const currentWeight = parseFloat(answers.current_weight);
    const imc = currentWeight / (height * height);

    const weight1Month = parseFloat(answers.weight_1month);
    const weight6Months = parseFloat(answers.weight_6months);
    const weightBeforeIllness = parseFloat(answers.weight_before_illness);

    let phenotypicCriteria = [];
    let etiologicCriteria = [];
    let hasPhenotypic = false;
    let hasEtiologic = false;
    let severity = 'none';

    // CRITÈRES PHÉNOTYPIQUES selon HAS

    // 1. Perte de poids
    let maxLoss1Month = 0;
    let maxLoss6Months = 0;
    let maxLossBeforeIllness = 0;

    if (weight1Month && weight1Month > currentWeight) {
      maxLoss1Month = ((weight1Month - currentWeight) / weight1Month) * 100;
    }

    if (weight6Months && weight6Months > currentWeight) {
      maxLoss6Months = ((weight6Months - currentWeight) / weight6Months) * 100;
    }

    if (weightBeforeIllness && weightBeforeIllness > currentWeight) {
      maxLossBeforeIllness = ((weightBeforeIllness - currentWeight) / weightBeforeIllness) * 100;
    }

    // Critère phénotypique : perte de poids modérée
    if (maxLoss1Month >= 5) {
      phenotypicCriteria.push(`Perte de poids ≥ 5% en 1 mois (${maxLoss1Month.toFixed(1)}%)`);
      hasPhenotypic = true;
    }
    if (maxLoss6Months >= 10) {
      phenotypicCriteria.push(`Perte de poids ≥ 10% en 6 mois (${maxLoss6Months.toFixed(1)}%)`);
      hasPhenotypic = true;
    }
    if (maxLossBeforeIllness >= 10) {
      phenotypicCriteria.push(`Perte de poids ≥ 10% par rapport au poids habituel (${maxLossBeforeIllness.toFixed(1)}%)`);
      hasPhenotypic = true;
    }

    // Critère phénotypique : perte de poids sévère
    if (maxLoss1Month >= 10) {
      phenotypicCriteria.push(`SÉVÈRE: Perte ≥ 10% en 1 mois (${maxLoss1Month.toFixed(1)}%)`);
      severity = 'severe';
    }
    if (maxLoss6Months >= 15) {
      phenotypicCriteria.push(`SÉVÈRE: Perte ≥ 15% en 6 mois (${maxLoss6Months.toFixed(1)}%)`);
      severity = 'severe';
    }
    if (maxLossBeforeIllness >= 15) {
      phenotypicCriteria.push(`SÉVÈRE: Perte ≥ 15% par rapport au poids habituel (${maxLossBeforeIllness.toFixed(1)}%)`);
      severity = 'severe';
    }

    // 2. IMC
    const imcThreshold = age >= 70 ? 22 : 18.5;
    const imcSevereThreshold = age >= 70 ? 20 : 17;

    if (imc < imcThreshold) {
      phenotypicCriteria.push(`IMC < ${imcThreshold} kg/m² (IMC: ${imc.toFixed(1)})`);
      hasPhenotypic = true;
    }

    if (imc < imcSevereThreshold) {
      phenotypicCriteria.push(`SÉVÈRE: IMC < ${imcSevereThreshold} kg/m² (IMC: ${imc.toFixed(1)})`);
      severity = 'severe';
    }

    // 3. Sarcopénie
    if (answers.sarcopenia === 'Oui') {
      phenotypicCriteria.push('Sarcopénie confirmée');
      hasPhenotypic = true;
    }

    // CRITÈRES ÉTIOLOGIQUES selon HAS

    // 1. Réduction des apports alimentaires
    if (answers.food_intake === 'Réduction ≥ 50% pendant > 1 semaine') {
      etiologicCriteria.push('Réduction alimentaire ≥ 50% pendant > 1 semaine');
      hasEtiologic = true;
    } else if (answers.food_intake === 'Réduction pendant > 2 semaines (quelle que soit l\'intensité)') {
      etiologicCriteria.push('Réduction alimentaire pendant > 2 semaines');
      hasEtiologic = true;
    }

    // 2. Malabsorption
    if (answers.malabsorption === 'Oui') {
      etiologicCriteria.push('Malabsorption/maldigestion');
      hasEtiologic = true;
    }

    // 3. Situation d'agression
    if (answers.pathology !== 'Aucune') {
      etiologicCriteria.push(`Situation d'agression: ${answers.pathology.toLowerCase()}`);
      hasEtiologic = true;
    }

    // CRITÈRE DE SÉVÉRITÉ : Albuminémie
    if (answers.albumin === '< 30 g/L') {
      phenotypicCriteria.push('SÉVÈRE: Albuminémie < 30 g/L');
      severity = 'severe';
    }

    // DIAGNOSTIC selon HAS : au moins 1 critère phénotypique ET 1 critère étiologique
    let diagnosis = 'none';
    if (hasPhenotypic && hasEtiologic) {
      diagnosis = severity === 'severe' ? 'severe' : 'moderate';
    }

    setResult({
      severity: diagnosis,
      phenotypicCriteria,
      etiologicCriteria,
      hasPhenotypic,
      hasEtiologic,
      details: {
        age,
        imc: imc.toFixed(1),
        loss1Month: maxLoss1Month.toFixed(1),
        loss6Months: maxLoss6Months.toFixed(1),
        lossBeforeIllness: maxLossBeforeIllness.toFixed(1)
      }
    });
  };

  const handleAnswer = (questionId, value) => {
    setAnswers({ ...answers, [questionId]: value });
  };

  const handleNext = () => {
    if (step < questions.length - 1) {
      setStep(step + 1);
    } else {
      evaluateDenutrition();
    }
  };

  const handlePrevious = () => {
    if (step > 0) {
      setStep(step - 1);
    }
  };

  const handleReset = () => {
    setStep(0);
    setAnswers({});
    setResult(null);
  };

  const handleEmailResult = () => {
    if (!result) return;

    const severityText = {
      'none': 'Pas de dénutrition',
      'moderate': 'Dénutrition modérée',
      'severe': 'Dénutrition sévère'
    };

    let emailBody = `ÉVALUATION NUTRITIONNELLE - CRITÈRES HAS\n`;
    emailBody += `========================================\n\n`;
    emailBody += `DIAGNOSTIC : ${severityText[result.severity]}\n\n`;
    
    emailBody += `DONNÉES PATIENT\n`;
    emailBody += `---------------\n`;
    emailBody += `Âge : ${result.details.age} ans\n`;
    emailBody += `IMC : ${result.details.imc} kg/m²\n`;
    if (result.details.loss1Month > 0) {
      emailBody += `Perte de poids sur 1 mois : ${result.details.loss1Month}%\n`;
    }
    if (result.details.loss6Months > 0) {
      emailBody += `Perte de poids sur 6 mois : ${result.details.loss6Months}%\n`;
    }
    if (result.details.lossBeforeIllness > 0) {
      emailBody += `Perte de poids depuis la maladie : ${result.details.lossBeforeIllness}%\n`;
    }
    
    if (result.severity !== 'none') {
      emailBody += `\nCRITÈRES PHÉNOTYPIQUES (HAS)\n`;
      emailBody += `-----------------------------\n`;
      result.phenotypicCriteria.forEach(c => {
        emailBody += `• ${c}\n`;
      });
      
      emailBody += `\nCRITÈRES ÉTIOLOGIQUES (HAS)\n`;
      emailBody += `---------------------------\n`;
      result.etiologicCriteria.forEach(c => {
        emailBody += `• ${c}\n`;
      });
    } else {
      emailBody += `\nANALYSE\n`;
      emailBody += `-------\n`;
      if (!result.hasPhenotypic && !result.hasEtiologic) {
        emailBody += `Aucun critère phénotypique ou étiologique n'est rempli.\n`;
      } else if (result.hasPhenotypic && !result.hasEtiologic) {
        emailBody += `Critère(s) phénotypique(s) présent(s) mais absence de critère étiologique.\n`;
      } else if (!result.hasPhenotypic && result.hasEtiologic) {
        emailBody += `Critère(s) étiologique(s) présent(s) mais absence de critère phénotypique.\n`;
      }
    }
    
    emailBody += `\n\nREMARQUE\n`;
    emailBody += `--------\n`;
    emailBody += `Cette évaluation est basée sur les critères HAS 2019 (adultes < 70 ans) et HAS 2021 (personnes âgées ≥ 70 ans).\n`;
    emailBody += `Le diagnostic de dénutrition nécessite AU MOINS 1 critère phénotypique ET AU MOINS 1 critère étiologique.\n`;
    emailBody += `\nCe résultat doit être confirmé par un professionnel de santé qualifié.\n`;

    // Copier dans le presse-papiers
    navigator.clipboard.writeText(emailBody).then(() => {
      alert('Résultat copié dans le presse-papiers ! Vous pouvez maintenant le coller dans votre email.');
    }).catch(() => {
      alert('Impossible de copier automatiquement. Veuillez sélectionner et copier le texte manuellement.');
    });
  };

  if (result) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
        <div className="max-w-4xl mx-auto">
          <div className="bg-white rounded-2xl shadow-xl p-8">
            <div className="flex items-center justify-between mb-6">
              <h1 className="text-3xl font-bold text-gray-800">
                Résultat de l'Évaluation
              </h1>
              <div className="flex items-center text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                <FileText size={14} className="mr-1" />
                Critères HAS 2019/2021
              </div>
            </div>

            {result.severity === 'none' && (
              <div className="bg-green-50 border-l-4 border-green-500 p-6 mb-6 rounded-r-lg">
                <div className="flex items-start">
                  <CheckCircle className="text-green-500 mr-4 flex-shrink-0 mt-1" size={28} />
                  <div className="flex-1">
                    <h2 className="text-xl font-bold text-green-800 mb-2">
                      Pas de dénutrition selon les critères HAS
                    </h2>
                    <p className="text-green-700 mb-4">
                      {!result.hasPhenotypic && !result.hasEtiologic && "Aucun critère phénotypique ou étiologique n'est rempli."}
                      {result.hasPhenotypic && !result.hasEtiologic && "Critère(s) phénotypique(s) présent(s) mais absence de critère étiologique."}
                      {!result.hasPhenotypic && result.hasEtiologic && "Critère(s) étiologique(s) présent(s) mais absence de critère phénotypique."}
                    </p>
                    <div className="bg-white p-4 rounded-lg text-sm space-y-1">
                      <p><strong>Âge :</strong> {result.details.age} ans</p>
                      <p><strong>IMC :</strong> {result.details.imc} kg/m²</p>
                      {result.details.loss1Month > 0 && <p><strong>Perte 1 mois :</strong> {result.details.loss1Month}%</p>}
                      {result.details.loss6Months > 0 && <p><strong>Perte 6 mois :</strong> {result.details.loss6Months}%</p>}
                      {result.details.lossBeforeIllness > 0 && <p><strong>Perte depuis maladie :</strong> {result.details.lossBeforeIllness}%</p>}
                    </div>
                  </div>
                </div>
              </div>
            )}

            {result.severity === 'moderate' && (
              <div className="bg-orange-50 border-l-4 border-orange-500 p-6 mb-6 rounded-r-lg">
                <div className="flex items-start">
                  <AlertCircle className="text-orange-500 mr-4 flex-shrink-0 mt-1" size={28} />
                  <div className="flex-1">
                    <h2 className="text-xl font-bold text-orange-800 mb-2">
                      Dénutrition Modérée (Critères HAS)
                    </h2>
                    <p className="text-orange-700 mb-4">
                      Le patient présente AU MOINS 1 critère phénotypique ET 1 critère étiologique, confirmant une dénutrition modérée.
                    </p>
                    
                    <div className="bg-white p-4 rounded-lg mb-4 text-sm space-y-1">
                      <p><strong>Âge :</strong> {result.details.age} ans</p>
                      <p><strong>IMC :</strong> {result.details.imc} kg/m²</p>
                      {result.details.loss1Month > 0 && <p><strong>Perte 1 mois :</strong> {result.details.loss1Month}%</p>}
                      {result.details.loss6Months > 0 && <p><strong>Perte 6 mois :</strong> {result.details.loss6Months}%</p>}
                      {result.details.lossBeforeIllness > 0 && <p><strong>Perte depuis maladie :</strong> {result.details.lossBeforeIllness}%</p>}
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                      <div className="bg-white p-4 rounded-lg">
                        <h3 className="font-semibold text-orange-900 mb-2 flex items-center">
                          <span className="bg-orange-200 text-orange-800 text-xs px-2 py-1 rounded mr-2">PHÉNOTYPIQUES</span>
                        </h3>
                        <ul className="list-disc list-inside text-orange-800 space-y-1 text-sm">
                          {result.phenotypicCriteria.map((c, i) => (
                            <li key={i}>{c}</li>
                          ))}
                        </ul>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg">
                        <h3 className="font-semibold text-orange-900 mb-2 flex items-center">
                          <span className="bg-orange-200 text-orange-800 text-xs px-2 py-1 rounded mr-2">ÉTIOLOGIQUES</span>
                        </h3>
                        <ul className="list-disc list-inside text-orange-800 space-y-1 text-sm">
                          {result.etiologicCriteria.map((c, i) => (
                            <li key={i}>{c}</li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {result.severity === 'severe' && (
              <div className="bg-red-50 border-l-4 border-red-600 p-6 mb-6 rounded-r-lg">
                <div className="flex items-start">
                  <AlertCircle className="text-red-600 mr-4 flex-shrink-0 mt-1" size={28} />
                  <div className="flex-1">
                    <h2 className="text-xl font-bold text-red-800 mb-2">
                      Dénutrition Sévère (Critères HAS)
                    </h2>
                    <p className="text-red-700 mb-4">
                      Le patient présente des critères de dénutrition sévère nécessitant une prise en charge nutritionnelle urgente et spécialisée.
                    </p>
                    
                    <div className="bg-white p-4 rounded-lg mb-4 text-sm space-y-1">
                      <p><strong>Âge :</strong> {result.details.age} ans</p>
                      <p><strong>IMC :</strong> {result.details.imc} kg/m²</p>
                      {result.details.loss1Month > 0 && <p><strong>Perte 1 mois :</strong> {result.details.loss1Month}%</p>}
                      {result.details.loss6Months > 0 && <p><strong>Perte 6 mois :</strong> {result.details.loss6Months}%</p>}
                      {result.details.lossBeforeIllness > 0 && <p><strong>Perte depuis maladie :</strong> {result.details.lossBeforeIllness}%</p>}
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                      <div className="bg-white p-4 rounded-lg">
                        <h3 className="font-semibold text-red-900 mb-2 flex items-center">
                          <span className="bg-red-200 text-red-800 text-xs px-2 py-1 rounded mr-2">PHÉNOTYPIQUES</span>
                        </h3>
                        <ul className="list-disc list-inside text-red-800 space-y-1 text-sm">
                          {result.phenotypicCriteria.map((c, i) => (
                            <li key={i} className={c.includes('SÉVÈRE') ? 'font-bold' : ''}>{c}</li>
                          ))}
                        </ul>
                      </div>
                      
                      <div className="bg-white p-4 rounded-lg">
                        <h3 className="font-semibold text-red-900 mb-2 flex items-center">
                          <span className="bg-red-200 text-red-800 text-xs px-2 py-1 rounded mr-2">ÉTIOLOGIQUES</span>
                        </h3>
                        <ul className="list-disc list-inside text-red-800 space-y-1 text-sm">
                          {result.etiologicCriteria.map((c, i) => (
                            <li key={i}>{c}</li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
              <div className="flex items-start">
                <Info className="text-blue-600 mr-3 flex-shrink-0 mt-1" size={20} />
                <div className="text-sm text-blue-800">
                  <p className="font-semibold mb-1">Diagnostic HAS :</p>
                  <p>Dénutrition = AU MOINS 1 critère phénotypique ET AU MOINS 1 critère étiologique</p>
                  <p className="mt-2 text-xs">
                    <strong>Références :</strong> HAS 2019 (adultes &lt; 70 ans) et HAS 2021 (personnes âgées ≥ 70 ans)
                  </p>
                </div>
              </div>
            </div>

            <div className="text-center">
              <div className="flex flex-col sm:flex-row gap-3 justify-center">
                <button
                  onClick={handleEmailResult}
                  className="bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center"
                >
                  <Mail size={20} className="mr-2" />
                  Copier pour email
                </button>
                <button
                  onClick={handleReset}
                  className="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors shadow-md"
                >
                  Nouvelle Évaluation
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  }

  const currentQuestion = questions[step];
  const currentAnswer = answers[currentQuestion.id];
  const canProceed = currentQuestion.optional || (currentAnswer !== undefined && currentAnswer !== '');

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
      <div className="max-w-2xl mx-auto">
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="mb-8">
            <div className="flex justify-between items-center mb-4">
              <h1 className="text-2xl font-bold text-gray-800">
                Évaluation Nutritionnelle
              </h1>
              <span className="text-sm font-semibold text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">
                {step + 1} / {questions.length}
              </span>
            </div>
            <div className="w-full bg-gray-200 rounded-full h-2">
              <div
                className="bg-indigo-600 h-2 rounded-full transition-all duration-300"
                style={{ width: `${((step + 1) / questions.length) * 100}%` }}
              />
            </div>
          </div>

          <div className="mb-8">
            <h2 className="text-xl font-semibold text-gray-800 mb-4">
              {currentQuestion.question}
            </h2>
            {currentQuestion.optional && (
              <p className="text-sm text-gray-500 mb-4">(Optionnel - cliquer sur Suivant pour passer)</p>
            )}

            {currentQuestion.type === 'select' && (
              <div className="space-y-3">
                {currentQuestion.options.map((option, index) => (
                  <button
                    key={index}
                    onClick={() => handleAnswer(currentQuestion.id, option)}
                    className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                      currentAnswer === option
                        ? 'border-indigo-600 bg-indigo-50 shadow-md'
                        : 'border-gray-200 hover:border-indigo-300 hover:bg-gray-50'
                    }`}
                  >
                    <span className={`font-medium ${
                      currentAnswer === option ? 'text-indigo-700' : 'text-gray-700'
                    }`}>
                      {option}
                    </span>
                  </button>
                ))}
              </div>
            )}

            {currentQuestion.type === 'number' && (
              <input
                type="number"
                step="0.1"
                placeholder={currentQuestion.placeholder}
                value={currentAnswer || ''}
                onChange={(e) => handleAnswer(currentQuestion.id, e.target.value)}
                className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-600 focus:outline-none text-lg"
              />
            )}

            {currentQuestion.type === 'date' && (
              <input
                type="date"
                value={currentAnswer || ''}
                onChange={(e) => handleAnswer(currentQuestion.id, e.target.value)}
                className="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-indigo-600 focus:outline-none text-lg"
              />
            )}
          </div>

          <div className="flex justify-between">
            <button
              onClick={handlePrevious}
              disabled={step === 0}
              className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                step === 0
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  : 'bg-gray-300 text-gray-700 hover:bg-gray-400'
              }`}
            >
              Précédent
            </button>
            <button
              onClick={handleNext}
              disabled={!canProceed}
              className={`px-6 py-3 rounded-lg font-semibold transition-colors ${
                !canProceed
                  ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                  : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-md'
              }`}
            >
              {step === questions.length - 1 ? 'Voir le résultat' : 'Suivant'}
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
